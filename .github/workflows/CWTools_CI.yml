name: CWTools CI

on:
  push:
    branches:    
    - master

jobs:
  cwtools_job:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - name: Get date of last commit
      run: |
        BEFORE=$(cat "$GITHUB_EVENT_PATH" | jq -r '.before')
        echo "https://api.github.com/repos/$GITHUB_REPOSITORY/commits/$BEFORE"
        BEFORE_PAYLOAD=$(curl -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$GITHUB_REPOSITORY/commits/$BEFORE")
        BEFORE_DATE=$(jq -r '.commit.committer.date' <<< "$BEFORE_PAYLOAD")
        git clone --single-branch --shallow-since="$BEFORE_DATE" "https://$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git" workspace
        cd workspace
        git diff --name-only "$BEFORE" "$GITHUB_SHA"
        
